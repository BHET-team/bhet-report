---
title: "Tests"
format: 
  pdf:
    keep-tex: true
    include-in-header:
      - text: |
         \usepackage{wrapfig}
         \usepackage{colortbl}
          \makeatletter
          \renewenvironment{table}%
            {\renewcommand\familydefault\sfdefault
             \@float{table}}
            {\end@float}
          \makeatother
  
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE, eval=T}
library(here)
library(osfr)
library(tidyverse)
library(readr)
library(readxl)
library(modelsummary)
library(marginaleffects)
library(kableExtra)
```

```{r set-data, inclulde=F, cache=T, message=F, warning=F, eval=F}
# read in master data
bhet_master_data <- osf_retrieve_node("vxur5")
bhet_master_data %>%
  osf_ls_files("Master Dataset (Seasons 1-4)",
               pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")

# read in data for Aim 1
aim_1 <- osf_retrieve_node("qsmbr")
aim_1 %>%
  osf_ls_files("Air pollution",
    pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")
```

Read in data
```{r data, include=FALSE, cache=TRUE}
library(tidyverse)
library(kableExtra)
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3"))
```

Make a table
```{r table, cache=TRUE, message=FALSE, echo=FALSE, eval=F}
#| label: tbl-table1
#| tbl-cap: "Summary: Numeric variables"

# select variables for table
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3",
    "freq_cough", "freq_phlegm", "freq_wheezing", 
    "freq_breath", "freq_no_chest"))

dt <- d %>%
  # restrict to baseline
  filter(wave==1) %>%
  # select variables for inclusion
  # select(ban_status_no, age_health, )
  mutate(ever_trt = ifelse(ban_status_no==0, 1 ,0),
    et = recode_factor(ever_trt, `0` = "Never treated", 
      `1` = "Ever treated"),
    `Age (years)` = age_health,
    `Female (%)` = ifelse(gender_health==2, 100, 0),
    `No education (%)` = ifelse(education_health==4, 100, 0),
    `Primary education (%)` = ifelse(education_health==1, 100, 0),
    `Secondary+ education (%)` = ifelse(
      education_health %in% c(2,3), 100, 0),
    `Never smoker (%)` = ifelse(smoking==3, 100, 0),
    `Former smoker (%)` = ifelse(smoking==2, 100, 0),
    `Current smoker (%)` = ifelse(smoking==1, 100, 0),
    `Never drinker (%)` = ifelse(freq_drink==1, 100, 0),
    `Occasional drinker (%)` = ifelse(freq_drink %in% 
      c(2:8), 100, 0),
    `Daily drinker (%)` = ifelse(freq_drink==9, 100, 0),
    `Systolic (mmHg)` = sys_brachial,
    `Diastolic (mmHg)` = dia_brachial,
    `Waist circumference (cm)` = waist_circ,
    `Body mass index (kg/m2)` = weight / (height/100)^2,
    `Frequency of coughing (%)` = 
      if_else(freq_cough < 3, 100, 0),
    `Frequency of phlegm (%)` = 
      if_else(freq_phlegm < 3, 100, 0),
    `Frequency of wheezing (%)` = 
      if_else(freq_wheezing < 3, 100, 0),
    `Shortness of breath (%)` = 
      if_else(freq_breath < 3, 100, 0),
    `Chest trouble (%)` = 
      if_else(freq_no_chest < 3, 100, 0),
    `Any respiratory problem (%)` = if_else(
      freq_cough < 3 |
      freq_phlegm < 3 |
      freq_wheezing < 3 |
      freq_breath < 3 |
      freq_no_chest < 3, 100, 0),
    `Temperature (°C)` = temp,
    `Personal PM2.5 (ug/m3)` = PM25conc_exposureugm3) %>%
  select(et, `Age (years)`, `Female (%)`, `No education (%)`, 
    `Primary education (%)`, `Secondary+ education (%)`, 
    `Never smoker (%)`, `Former smoker (%)`, 
    `Current smoker (%)`, `Never drinker (%)`, 
    `Occasional drinker (%)`, `Daily drinker (%)`,
    `Systolic (mmHg)`, `Diastolic (mmHg)`,
    `Waist circumference (cm)`,
    `Body mass index (kg/m2)`, 
    `Frequency of coughing (%)`,
    `Frequency of wheezing (%)`,
    `Shortness of breath (%)`,
    `Chest trouble (%)`,
    `Any respiratory problem (%)`,
    `Temperature (°C)`,
    `Personal PM2.5 (ug/m3)`)

# caption <- '\\label{#tbl-table1}Descriptive statistics, by treatment status'
reference <- 'Includes all individuals sampled at each of 3 waves.'

# add empty rows for categorical variables
# grouped categories
nrn <- c("Demographics:", "Health measures:",
  "Environmental measures:")
# empty data frame
nr <- data.frame(matrix(ncol = 7, nrow = length(nrn)))
nr$X1 <- nrn
nr[is.na(nr)] <- " "

# placement in table
attr(nr, 'position') <- c(1, 7, 23)

options(modelsummary_format_numeric_latex = "plain")

t1 <- datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference)

t1 %>%
  kable_styling(font_size = 9) %>%
  row_spec(c(1,7,23), bold = T)
```
See @tbl-table1 for details.

Now try for the kable version:
```{r t2, cache=TRUE, message=FALSE, echo=FALSE, eval=F}
#| label: tbl-table2
#| tbl-cap: "Summary: Numeric variables using kableExtra"
t2 <- datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference, output = 'kableExtra')

t2 %>%
  kable_styling(font_size = 9) %>%
  row_spec(c(1,7,18), bold = T)
```


```{r, echo=F, eval=F}
#| label: tbl-table3
#| tbl-cap: "Summary: Numeric variables using kableExtra"


library(tidyverse)
library(here)
library(kableExtra)
apdid <- read_csv(here("data-clean", 
  "DID_air_pollution.csv")) 

apdidt <- apdid %>% 
  relocate(`Category`) %>%
  pivot_wider(names_from = Effect, values_from = 
    c(Estimate, CI_low, CI_upper), names_vary = "slowest") %>% 
  mutate(`Pollutant` = 
    ifelse(row_number() == 1, "Black carbon", `Pollutant`),
    `Pollutant` = 
    ifelse(row_number() == 2, "PM2.5", `Pollutant`),)

kable(apdidt, digits = 2,
  col.names = c(" ", " ", "Estimate", "LL", "UL", 
   "Estimate", "LL", "UL"), "latex", booktabs = T,
  linesep = "") %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1:2, valign = "top") %>% 
  pack_rows("Air pollution", 1, 6) %>%
  add_header_above(c(" " = 2, 
                    "DiD" = 3, "Adjusted DiD" = 3))
#  pack_rows("Air pollution", 0,1) %>%
#  pack_rows("Personal exposure (µg/m3)", 2, 3) %>%
#  pack_rows("Indoor PM (µg/m3)", 4, 5) %>%
#  pack_rows("Outdoor PM (µg/m3)", 6, 7)
```

Another DiD table
```{r ap-did-table, echo=F, message=F, warning=F, eval=F}
library(tidyverse)
library(here)
library(kableExtra)

# air pollution results
ap_table <- read_rds(here("data-clean", 
  "ap-did-table.rds")) 

# temperature results
# temp_table <- read_rds(here("data-clean",
  # "resp-did.rds"))
temp_table <- tibble(
  category = "Point temp", outcome = "Mean", estimate_1 = 1.96,
  ci_1 = "(0.96, 2.96)", estimate_2 = NA, 
  ci_2 = " "
)

# join tables
m_table <- bind_rows(ap_table, temp_table)

kable(m_table,  digits = 2,
  col.names = c(" ", " ", "Estimate", "(95% CI)", 
   "Estimate", "(95% CI)"), "latex", booktabs = T,
  linesep = "", align = 'llcccc') %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1:2, valign = "top") %>% 
  pack_rows("Air pollution (µg/m3)", 1, 6) %>%
  pack_rows("Indoor temperature", 7, 7) %>%
  add_header_above(c(" " = 2, 
    "DiD" = 2, "Adjusted DiD*" = 2)) %>%
  footnote(symbol = "Footnote A")
```

See @tbl-table3 for more.

```{r bp-resp-table, echo=F, message=F, warning=F, eval=F}
library(tidyverse)
library(here)
library(kableExtra)

# bp results from Talia
bp_policy_t <- tibble(
  category = rep(c("Systolic BP", "Diastolic BP", 
    "Pulse Pressure", "BP Amplification x10"), each=2),
  outcome = c("Brachial","Central","Brachial",
    "Central", "Brachial","Central", "Pulse pressure",
    "Systolic BP"),
  estimate_1 = c(-0.79, -1.04, -1.29, -1.35, 0.5,
    0.31, 0.1, 0.2),
  ci_1 = c("(-2.63, 1.04)", "(-2.82, 0.73)",
    "(-2.62, 0.04)", "(-2.66, 0.04)", "(-0.71, 1.70)",
    "(-0.85, 1.46)", "(-0.12, 1.40)", "(-0.20, 0.50)"),
  estimate_2 = c(-1.4, -1.56, -1.60, -1.66, 0.21,
    0.10, 0.00, 0.10),
  ci_2 = c("(-3.31, 0.51)", "(-3.40, 0.28)",
    "(-2.96, -0.25)", "(-2.97, -0.34)", "(-1.00, 1.41)",
    "(-1.01, 1.20)", "(-1.20, 1.20)", "(-0.20, 0.40)")
)

# respiratory results
r_table <- read_rds(here("data-clean",
  "resp-did.rds"))

# FeNO results
feno_table <- tibble(
  category = "Measured", outcome = "FeNO (ppb)", estimate_1 = 0.17,
  ci_1 = "(-2.24, 2.58)", estimate_2 = 0.55, 
  ci_2 = "(-2.13, 3.13)"
)

inf_table <- tibble(
  category = " ", 
  outcome = c("IL6", "TNF-alpha",	"CRP",	"MDA"),
  estimate_1 = c(6.8, 24.3, 2.7, 7.6),
  ci_1 = c("(-12.2, 30.0)", "(-1.3, 56.4)", 
           "(-19.8, 31.6)", "(-8.7, 26.9)"),
  estimate_2 = c(5.9, 24.7, 3.8, 6.5),
  ci_2 = c("(-13.8, 30.2)", "(-0.9, 54.2)", 
           "(-19.4, 33.6)", "(-9.7, 25.5)")
)

# join tables
op_table <- bind_rows(bp_policy_t, r_table, 
 feno_table, inf_table)

kable(op_table,  digits = 2,
  col.names = c(" ", " ", "Estimate", "(95% CI)", 
   "Estimate", "(95% CI)"), "latex", booktabs = T,
  linesep = "", align = 'llcccc') %>%
  kable_styling(full_width = F) %>%
  collapse_rows(columns = 1:2, valign = "top") %>% 
  pack_rows("Blood pressure (mmHg)", 1, 8) %>%
  pack_rows("Respiratory\noutcomes", 9, 15) %>%
  pack_rows("Inflammatory\nmarkers (%)", 16, 19) %>%
  add_header_above(c(" " = 2, 
    "DiD" = 2, "Adjusted DiD*" = 2)) %>%
  footnote(general = "pp = percentage points, ppb = parts per billion",
    symbol = "List of adjustments...", footnote_as_chunk = T)
```


```{r tbl-pmf, echo=F, eval=F}
library(here)
library(tidyverse)
library(kableExtra)
#| label: tbl-pmf
#| tbl-cap: "PMF error diagnostics"

options(knitr.kable.NA = " ")
t_pmf <- read_csv(here("data-clean", 
  "pmf-error.csv"))

kable(t_pmf,
 "latex", booktabs = T,
  linesep = "", align = 'lllll') %>%
  kable_styling(full_width = F,
    font_size = 9) %>%
  column_spec(2:5, width = "10em") %>%
  add_header_above(c(" " = 1, 
    "Potential Factor Solution" = 4))
```


```{r fig-dag, engine='tikz', echo=F, out.width="60%"}
\begin{tikzpicture}[shorten > = 1pt, line width=0.5pt, font=\scriptsize]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
\node (m1) at  (3.5,1) [align=center] {PM\textsubscript{2.5}\\($M_{1}$)};
\node (m2) at  (3.5,-1) [align=center] {Indoor\\Temp\\($M_{2}$)};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
\node (w) at (2,-1.5) [align=center] {$W$};
\foreach \from/\to in {x/t, t/y, t/m1, t/m2, m1/y, m2/y, w/m1, w/m2}
  \draw [->] (\from) -- (\to);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x) to [bend left=20] (m1);
\draw [->] (x) to [bend right=25] (m2);
\draw [->] (w) to [bend right=45] (y);
\end{tikzpicture}
```

\newpage

```{r fig-map, echo=FALSE, out.width = "70%"}
library(here)
#| label: fig-cbhp-map
#| fig-cap: "Map of village implementation of CBHP policy"

knitr::include_graphics(here("images", 
  "policy-implementation-map.png"))
```

See @fig-cbhp-map.

\newpage

The source profiles for the four-factor solution are presented in Figure X. The first source was identified as dust by high percentages of crustal elements like wi-Ca, Si, and wi-Mg. The second source was constituted of non-sulfate sulfur as well as secondary inorganic ions (ammonium, nitrate, and sulfate). Non-sulfate sulfur is a tracer for primary coal combustion, while secondary inorganic ions indicate a secondary source. Since coal combustion is a major source of energy in our study area, it is likely that the second source is a mixture of primary and secondary emissions that originate from coal and other sulfurous fuel combustion. 

\begin{wrapfigure}{R}{0.7\textwidth}
\includegraphics[width=0.7\textwidth]{images/policy-implementation-map.png}
\caption{\label{fig-map}{Google scholar metrics}}
\end{wrapfigure}

Additionally, in Figure\ref{fig-map} for details. the mean source contribution of the second source is higher in outdoor than personal exposure measurements. Secondary formation occurs outdoors in the presence of sunlight, so higher outdoor concentrations compared to personal exposure further support our naming the second source and sulfur secondary. The third source had high percentages of ws-Ca nd Al, which in our study region, has been found to be indicative of transported dust from dust storms that can occur in the spring. While our samples were collected during winter months only, it is possible that transported dust from previous years still remained. The fourth source was characterized by high percentages of tracers for both coal (OC, wi-K, chloride, Pb) and biomass combustion (EC, ws-K). Coal and biomass combustion is common in our study setting so this source is likely a mixture of the two combustion sources.

```{r atbl-het, echo=F}
options("modelsummary_format_numeric_latex" = "plain")
models_personal <- read_rds(here("outputs", "m_ppm.rds"))
data_personal <- read_rds(here("data-clean", "d_personal.rds"))

models_bc <- read_rds(here("outputs", "m_pbc.rds"))
data_bc <- read_rds(here("data-clean", "d_bc.rds"))

personal_all <- slopes(models_personal$e2, 
  newdata = subset(data_personal, treat==1), 
  variables = "treat", by = "treat")

personal_all <- personal_all %>% 
  mutate(term = "ATT(All, All)") 

personal_ct <- slopes(models_personal$e2, 
  newdata = subset(data_personal, treat==1), 
  variables = "treat", by = c("cohort_year", "year"))

personal_ct <- personal_ct %>% 
  mutate(term = c("ATT(2019, 2019)", "ATT(2019, 2021)", 
    "ATT(2020, 2021)", "ATT(2021, 2021)"))

bc_all <- slopes(models_bc$e2, 
  newdata = subset(data_bc, treat==1), 
  variables = "treat", by = "treat")

bc_all <- bc_all %>% 
  mutate(term = "ATT(All, All)") 

bc_ct <- slopes(models_bc$e2, 
  newdata = subset(data_bc, treat==1), 
  variables = "treat", by = c("cohort_year", "year"))

bc_ct <- bc_ct %>% 
  mutate(term = c("ATT(2019, 2019)", "ATT(2019, 2021)", 
    "ATT(2020, 2021)", "ATT(2021, 2021)"))

personal_panels <- list(
  "Average ATT" = list(
    "Personal: PM2.5" = personal_all, 
    "Personal: BC" = bc_all),
  "Cohort-Time ATTs" = list(
    "Personal: PM2.5" = personal_ct, 
    "Personal: BC" = bc_ct)
)

personal_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_personal$ht1$df1, ", # ", 
    models_personal$ht1$df2, ")= " ,
    round(models_personal$ht1$statistic, digits=3), ", p= ",
    round(models_personal$ht1$p.value, digits=3), sep="")

modelsummary(
  personal_panels,
  shape = "rbind",
  gof_omit = ".*",
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  statistic = NULL,
  fmt = 2, output = 'latex', 
  notes = list('First note.', 'Second note.')
)

# modelsummary(list("Adjusted ETWFE" = mstest1), 
#   shape = term ~ model, 
#   estimate = "{estimate} [{conf.low}, {conf.high}]", 
#   statistic = NULL, gof_map = "nobs", 
#   notes = paste("Joint test that all ATTs are equal: ", "F(", m_p$ht1$df1, ", # ", m_p$ht1$df2, ")= " ,round(m_p$ht1$statistic, digits=3), ", p= ", # round(m_p$ht1$p.value, digits=3), sep=""), output = 'latex')
```

Another example
```{r, echo=F, eval=F}

# read in personal exposure heterogeneity table
aph_table <- read_rds(here("outputs", 
  "ap-het-table.rds"))

models_ppm <- read_rds(here("outputs/models", "m_ppm.rds"))
models_pbc <- read_rds(here("outputs/models", "m_pbc.rds"))

models_ppm_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_ppm$ht1$df1, ", ", 
    models_ppm$ht1$df2, ")= " , 
    round(models_ppm$ht1$statistic, digits=3), ", p= ", 
    round(models_ppm$ht1$p.value, digits=3), sep="")

models_pbc_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_pbc$ht1$df1, ", ", 
    models_pbc$ht1$df2, ")= " , 
    round(models_pbc$ht1$statistic, digits=3), ", p= ", 
    round(models_pbc$ht1$p.value, digits=3), sep="")

kable(aph_table, digits = 2, escape = FALSE,
  col.names =c("Cohort", "Time", "ATT", "(95\\%CI)", 
   "ATT", "(95\\%CI)"), "latex", booktabs = T,
  linesep = "", align = 'cccccc') %>%
  column_spec(1:2, width = "1.5cm") %>%
  kable_styling(full_width = F) %>%
  pack_rows("Average ATT", 1, 2, indent = F) %>%
  pack_rows("Cohort-Time ATTs", 2, 5, indent = F) %>%
  add_header_above(c(" " = 2, 
    "PM2.5\\\\textsuperscript{a}" = 2, 
    "Black carbon\\\\textsuperscript{b}" = 2),
    escape = FALSE) %>%
  footnote(alphabet=c(models_ppm_note, models_pbc_note)) 
```

```{r ap-season, echo=F}
options(knitr.kable.NA = " ")
ap_season <- read_csv(here("data-clean", 
  "ap-conc-season.csv"))

ap_season %>%
  pivot_longer(
    cols = Mean_S1:GM_S4,
    names_to = c("avg", ".value"),
    names_pattern = "(.*)_S(.)") %>%
  pivot_wider(
    names_from = metric,
    values_from = c(`1`, `2`, `3`, `4`)
  ) %>%
  select(-category) %>%
  kable(col.names =c("", "", "", "",  
   "Est.", "CI", "Est.", "CI", "Est.", "CI", 
   "Est.", "CI"), # "latex", booktabs = T,
  linesep = "", align = 'lllllcccccccc') %>% 
  kable_styling(font_size = 9) %>% 
  column_spec(1:4, width = "4em") %>%
  collapse_rows(columns = 1:3, valign = "top") %>%
  pack_rows("Personal", 1, 4, indent = F) %>%
  pack_rows("Indoor", 5, 10, indent = F) %>%
  pack_rows("Outdoor", 11, 16, indent = F) %>%
  add_header_above(c(" " = 4, "Season 1" = 2,
    "Season 2" = 2, "Season 3" = 2,
    "Season 4" = 2)) %>%
  footnote(general = "Note: Est. = Estimate, CI = 95\\\\% CI",  
           general_title = "", escape = F)
```

Respiratory tables
```{r, echo=F}

# read in personal exposure heterogeneity table
resp_any_table <- read_rds(here("outputs", 
  "resp-het-resp.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("\\\\small{Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$resp$df1, ", ", 
    models_resp$resp$df2, ")= " , 
    round(models_resp$resp$statistic, digits=3), ", p= ", 
    round(models_resp$resp$p.value, digits=3),"}", sep="")

kable(resp_any_table, digits = 2, escape = FALSE,
  col.names =c("Cohort", "Time", 
    "ATT", "(95\\%CI)"), 
   "latex", booktabs = T,
  linesep = "", align = 'cccc') %>%
  column_spec(1:2, width = "2cm") %>%
  kable_styling(full_width = F) %>%
  pack_rows("Average ATT", 1, 2, indent = F) %>%
  pack_rows("Cohort-Time ATTs", 2, 5, indent = F) %>%
  footnote(general=models_resp_note,
    general_title = "", escape = F)
```
