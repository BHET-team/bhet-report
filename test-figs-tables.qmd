---
title: "Tests"
format: 
  pdf:
    keep-tex: true
    include-in-header:
      - text: |
         \usepackage{wrapfig}
  
---

```{r setup, include=FALSE, cache=TRUE}
library(here)
library(osfr)
library(tidyverse)
library(readxl)

# read in master data
bhet_master_data <- osf_retrieve_node("vxur5")
bhet_master_data %>%
  osf_ls_files("Master Dataset (Seasons 1-4)",
               pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")

# read in data for Aim 1
aim_1 <- osf_retrieve_node("qsmbr")
aim_1 %>%
  osf_ls_files("Air pollution",
    pattern = "DID_air_pollution.csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")
```


Read in data
```{r data, include=FALSE, cache=TRUE}
library(tidyverse)
library(kableExtra)
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3"))
```

Make a table
```{r table, cache=TRUE, message=FALSE, echo=FALSE, eval=F}
#| label: tbl-table1
#| tbl-cap: "Summary: Numeric variables"

# select variables for table
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3",
    "freq_cough", "freq_phlegm", "freq_wheezing", 
    "freq_breath", "freq_no_chest"))

dt <- d %>%
  # restrict to baseline
  filter(wave==1) %>%
  # select variables for inclusion
  # select(ban_status_no, age_health, )
  mutate(ever_trt = ifelse(ban_status_no==0, 1 ,0),
    et = recode_factor(ever_trt, `0` = "Never treated", 
      `1` = "Ever treated"),
    `Age (years)` = age_health,
    `Female (%)` = ifelse(gender_health==2, 100, 0),
    `No education (%)` = ifelse(education_health==4, 100, 0),
    `Primary education (%)` = ifelse(education_health==1, 100, 0),
    `Secondary+ education (%)` = ifelse(
      education_health %in% c(2,3), 100, 0),
    `Never smoker (%)` = ifelse(smoking==3, 100, 0),
    `Former smoker (%)` = ifelse(smoking==2, 100, 0),
    `Current smoker (%)` = ifelse(smoking==1, 100, 0),
    `Never drinker (%)` = ifelse(freq_drink==1, 100, 0),
    `Occasional drinker (%)` = ifelse(freq_drink %in% 
      c(2:8), 100, 0),
    `Daily drinker (%)` = ifelse(freq_drink==9, 100, 0),
    `Systolic (mmHg)` = sys_brachial,
    `Diastolic (mmHg)` = dia_brachial,
    `Waist circumference (cm)` = waist_circ,
    `Body mass index (kg/m2)` = weight / (height/100)^2,
    `Frequency of coughing (%)` = 
      if_else(freq_cough < 3, 100, 0),
    `Frequency of phlegm (%)` = 
      if_else(freq_phlegm < 3, 100, 0),
    `Frequency of wheezing (%)` = 
      if_else(freq_wheezing < 3, 100, 0),
    `Shortness of breath (%)` = 
      if_else(freq_breath < 3, 100, 0),
    `Chest trouble (%)` = 
      if_else(freq_no_chest < 3, 100, 0),
    `Any respiratory problem (%)` = if_else(
      freq_cough < 3 |
      freq_phlegm < 3 |
      freq_wheezing < 3 |
      freq_breath < 3 |
      freq_no_chest < 3, 100, 0),
    `Temperature (°C)` = temp,
    `Personal PM2.5 (ug/m3)` = PM25conc_exposureugm3) %>%
  select(et, `Age (years)`, `Female (%)`, `No education (%)`, 
    `Primary education (%)`, `Secondary+ education (%)`, 
    `Never smoker (%)`, `Former smoker (%)`, 
    `Current smoker (%)`, `Never drinker (%)`, 
    `Occasional drinker (%)`, `Daily drinker (%)`,
    `Systolic (mmHg)`, `Diastolic (mmHg)`,
    `Waist circumference (cm)`,
    `Body mass index (kg/m2)`, 
    `Frequency of coughing (%)`,
    `Frequency of wheezing (%)`,
    `Shortness of breath (%)`,
    `Chest trouble (%)`,
    `Any respiratory problem (%)`,
    `Temperature (°C)`,
    `Personal PM2.5 (ug/m3)`)

# caption <- '\\label{#tbl-table1}Descriptive statistics, by treatment status'
reference <- 'Includes all individuals sampled at each of 3 waves.'

# add empty rows for categorical variables
# grouped categories
nrn <- c("Demographics:", "Health measures:",
  "Environmental measures:")
# empty data frame
nr <- data.frame(matrix(ncol = 7, nrow = length(nrn)))
nr$X1 <- nrn
nr[is.na(nr)] <- " "

# placement in table
attr(nr, 'position') <- c(1, 7, 23)

options(modelsummary_format_numeric_latex = "plain")

t1 <- datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference)

t1 %>%
  kable_styling(font_size = 9) %>%
  row_spec(c(1,7,23), bold = T)
```
See @tbl-table1 for details.

Now try for the kable version:
```{r t2, cache=TRUE, message=FALSE, echo=FALSE, eval=F}
#| label: tbl-table2
#| tbl-cap: "Summary: Numeric variables using kableExtra"
t2 <- datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference, output = 'kableExtra')

t2 %>%
  kable_styling(font_size = 9) %>%
  row_spec(c(1,7,18), bold = T)
```

```{r}
apdid <- read_csv(here("data-clean", 
  "DID_air_pollution.csv")) 

apdidt <- apdid %>% pivot_wider(names_from = Effect, values_from = c(Estimate, CI_low, CI_upper), names_vary = "slowest") %>% 
  select(-Category)

kable(apdidt, digits = 2,
  col.names = c("Outcome", "Estimate", "LL", "UL", 
   "Estimate", "LL", "UL"), "latex", booktabs = T,
  linesep = "") %>%
  kable_styling() %>%
  add_header_above(c(" " = 1, 
                     "DiD" = 3, "Adjusted DiD" = 3)) %>%
  pack_rows("Personal exposure", 1, 2) %>%
  pack_rows("Indoor PM", 3, 4) %>%
  pack_rows("Outdoor PM", 5, 6)
```

\newpage

:::layout[[30,70]]

Some text that should go beside the figure here.

<div>

![](images/policy-implementation-map.png)


</div>

:::

```{r fig-map, echo=FALSE, out.width = "50%"}
#| label: fig-map
#| fig-cap: "Map of village implementation of CBHP policy"
#knitr::include_graphics(here("images", 
#  "policy-implementation-map.png"))
```


\newpage

The source profiles for the four-factor solution are presented in Figure X. The first source was identified as dust by high percentages of crustal elements like wi-Ca, Si, and wi-Mg. The second source was constituted of non-sulfate sulfur as well as secondary inorganic ions (ammonium, nitrate, and sulfate). Non-sulfate sulfur is a tracer for primary coal combustion, while secondary inorganic ions indicate a secondary source. Since coal combustion is a major source of energy in our study area, it is likely that the second source is a mixture of primary and secondary emissions that originate from coal and other sulfurous fuel combustion. 

\begin{wrapfigure}{R}{0.7\textwidth}
\includegraphics[width=0.7\textwidth]{images/policy-implementation-map.png}
\caption{Google scholar metrics}
\end{wrapfigure}

Additionally, the mean source contribution of the second source is higher in outdoor than personal exposure measurements. Secondary formation occurs outdoors in the presence of sunlight, so higher outdoor concentrations compared to personal exposure further support our naming the second source and sulfur secondary. The third source had high percentages of ws-Ca nd Al, which in our study region, has been found to be indicative of transported dust from dust storms that can occur in the spring. While our samples were collected during winter months only, it is possible that transported dust from previous years still remained. The fourth source was characterized by high percentages of tracers for both coal (OC, wi-K, chloride, Pb) and biomass combustion (EC, ws-K). Coal and biomass combustion is common in our study setting so this source is likely a mixture of the two combustion sources.
